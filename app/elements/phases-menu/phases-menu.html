<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-menu/core-menu.html">
<link rel="import" href="../../bower_components/core-collapse/core-collapse.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">

<polymer-element name="phases-menu" attributes="userSelection project">
  <template>
    <!-- build:css phases-menu.css -->
    <link rel="stylesheet" type="text/css" href="phases-menu.css">
    <!-- endbuild-->
    <!-- ajax functionality -->
    <core-ajax
      id = "projectAjax"
      auto
      url="/"
      params=''
      handleAs="json"
      on-core-response="{{handleResponse}}"
      core-error="{{handleError}}">
    </core-ajax>
    <core-ajax
      id ="projectAjaxPost"
      url="/"
      handleAs="json"
      method="POST"
      contentType="application/json"
      on-core-response="{{handleResponsePost}}"
      core-error="{{handleErrorPost}}">
    </core-ajax>

    <core-menu class="phases-wrapper" selected="0">
      <template repeat="{{phase in project.phases}}">
        <div class="phase">
          <paper-item class="phase-header" on-click="{{openPhase}}" target-id="{{phase.id}}">
            <div vertical layout>
              <span class="phase-name">{{phase.name}}</span>
              <span class="phase-duration">{{phase.duration.start}} - {{phase.duration.end}}</span>
            </div>
            <div class="phase-color-code" style="background:{{phase.color}}"></div>
          </paper-item>
          <div>
            <core-collapse id="phase_content{{phase.id}}">
              <div>
                <!-- tähän template kans -->
                <details class="phase-skills">
                  <summary >Skill category</summary>
                  <template repeat="{{skill in phase.skills}}">
                    <paper-item class="skill" no-padding>
                      <div flex >{{skill.name}}</div>
                      <div title="We still need [[skill.resource_need - skill.current_resource_amount]] person(s)!" class="circle free xs-small" style="background:{{phase.color}}">[[skill.resource_need - skill.current_resource_amount]]</div>
                    </paper-item>
                  </template>
                </details>
              </div>
            </core-collapse>
          </div>
        </div>
      </template>
    </core-menu>

  </template>

  <script>
    Polymer( "phases-menu", {
      ready: function() {
        // var ajax = this.$.projectAjaxPost;
        // ajax.body = JSON.stringify(
        //   {
        //     "email": "kekkonen@aalto.fi",
        //     "first_name": "Urho",
        //     "last_name": "Kekkonen"
        //   }
        // );
        // ajax.go();
        // console.log(this.$.phase_content1);
      },
      created: function() {
        console.log("created");
        // this.project  =[];
      },
      getRandomColor: function() {
          var letters = '0123456789ABCDEF'.split('');
          var color = '#';
          for (var i = 0; i < 6; i++ ) {
              color += letters[Math.floor(Math.random() * 16)];
          }
          console.log(this.changeLuminance(color, -0.4));
          return this.changeLuminance(color, -0.4);
      },
      changeLuminance: function(hex, lum) {
        // validate hex string
        hex = String(hex).replace(/[^0-9a-f]/gi, '');
        if (hex.length < 6) {
          hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
        }
        lum = lum || 0;

        // convert to decimal and change luminosity
        var rgb = "#", c, i;
        for (i = 0; i < 3; i++) {
          c = parseInt(hex.substr(i*2,2), 16);
          c = Math.round(Math.min(Math.max(0, c + (c * lum)), 255)).toString(16);
          rgb += ("00"+c).substr(c.length);
        }
        return rgb;
      },
      handleResponse: function(event, response) {
        // this.phases =
        console.log(response);
        this.project = {
          name: "Project 1",
          duration: {start: "1/1/2012", end: "3/7/2012"}
        };
        this.project.phases =
        [
          // Color codes: #33ADD6, #CC66FF, #E65C8A, #FF8533, #FFE680, #4DDB94, #52CCCC, #5E7E9E, #8F0000
          {
            name: "Planning",
            id: 1,
            color: this.getRandomColor(),
            duration: {start: "1/1/2012", end: "2/7/2012"},
            skills: [
              {
                name: "Javascript",
                resource_need: "4",
                current_resource_amount: "2"
              },
              {name: "UI Design", resource_need: "2", current_resource_amount: "1"},
              {name: "PHP", resource_need: "3", current_resource_amount: "0"},
              {name: "Python", resource_need: "4", current_resource_amount: "0"},
              {name: "Python", resource_need: "5", current_resource_amount: "1"},
              {name: "Python", resource_need: "6", current_resource_amount: "0"},
              {name: "Python", resource_need: "7", current_resource_amount: "2"}
            ]
          },
          {name: "Design", id: 2, color: this.getRandomColor(), duration: {start: "1/1/2012", end: "1/7/2012"},
            skills: [
              {name: "Javascript", resource_need: "4", current_resource_amount: "2"},
              {name: "UI Design", resource_need: "2", current_resource_amount: "1"},
              {name: "PHP", resource_need: "3", current_resource_amount: "0"},
              {name: "Python", resource_need: "4", current_resource_amount: "0"},
              {name: "Python", resource_need: "5", current_resource_amount: "1"},
              {name: "Python", resource_need: "6", current_resource_amount: "0"},
              {name: "Python", resource_need: "7", current_resource_amount: "2"}]
          },
          {name: "Implementation", id: 3, color: this.getRandomColor(), duration: {start: "1/15/2012", end: "2/2/2012"},
            skills: [
              {name: "Javascript", resource_need: "4", current_resource_amount: "2"},
              {name: "UI Design", resource_need: "2", current_resource_amount: "1"},
              {name: "PHP", resource_need: "3", current_resource_amount: "0"},
              {name: "Python", resource_need: "4", current_resource_amount: "0"},
              {name: "Python", resource_need: "5", current_resource_amount: "1"},
              {name: "Python", resource_need: "6", current_resource_amount: "0"},
              {name: "Python", resource_need: "7", current_resource_amount: "2"}]
          },
          {name: "Testing", id: 4, color: this.getRandomColor(), duration: {start: "1/14/2012", end: "2/7/2012"},
            skills: [
              {name: "Javascript", resource_need: "4", current_resource_amount: "2"},
              {name: "UI Design", resource_need: "2", current_resource_amount: "1"},
              {name: "PHP", resource_need: "3", current_resource_amount: "0"},
              {name: "Python", resource_need: "4", current_resource_amount: "0"},
              {name: "Python", resource_need: "5", current_resource_amount: "1"},
              {name: "Python", resource_need: "6", current_resource_amount: "0"},
              {name: "Python", resource_need: "7", current_resource_amount: "2"}]
          },
          {name: "Closure", id: 5, color: "#e6d873", duration: {start: "2/1/2012", end: "2/7/2012"},
            skills: [
              {name: "Javascript", resource_need: "4", current_resource_amount: "2"},
              {name: "UI Design", resource_need: "2", current_resource_amount: "1"},
              {name: "PHP", resource_need: "3", current_resource_amount: "0"},
              {name: "Python", resource_need: "4", current_resource_amount: "0"},
              {name: "Python", resource_need: "5", current_resource_amount: "1"},
              {name: "Python", resource_need: "6", current_resource_amount: "0"},
              {name: "Python", resource_need: "7", current_resource_amount: "2"}]
          }
        ];
        this.userSelection.phase = this.project.phases[0].name;
        this.fire('show-timeline', {msg: 'Load-skill event fired'});
      },
      handleResponsePost: function(event, response) {
        // this.phases =
        console.log(response);
        console.log("post");
      },
      handleError: function(event, response) {
        console.log(response);
      },
      handleErrorPost: function(event, response) {
        console.log(response);
        console.log("postError");
      },
      openPhase: function(event, detail, sender){
        console.log(sender.templateInstance.model.phase.name);
        this.userSelection.phase = sender.templateInstance.model.phase.name;
        var querystring = "#phase_content"+sender.getAttribute("target-id");
        this.shadowRoot.querySelector(querystring).toggle();
        this.fire('load-skill', {msg: 'Load-skill event fired'});
      }

    });
  </script>

</polymer-element>

