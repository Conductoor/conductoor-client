<link rel="import" href="../../bower_components/polymer/polymer.html">

<polymer-element name="conductoor-profile" attributes="userSelection project">
  <template>
    <link rel="import" href="../bower_components/paper-item/paper-button.html">
    <link rel="stylesheet" href="conductoor-profile.css">

    <core-ajax
      id ="addEmployeeAjax"
      url="https://conductoor-api.herokuapp.com/allocations/"
      handleAs="json"
      method="POST"
      contentType="application/json"
      on-core-response="{{handleResponse}}"
      core-error="{{handleError}}">
    </core-ajax>

    <div layout vertical fit class="section profile">
      <div relative class="profile-header">
        <div horizontal layout center>
          <div flex two>
            <div class="profile-img"><img src="../../images/no_image.png"></div>
          </div>
          <div flex three>
            <div class="profile-name">{{userSelection.selectedPerson.first_name}} {{userSelection.selectedPerson.last_name}}</div>
            <div class="profile-title">{{userSelection.selectedPerson.title}}</div>
          </div>
        </div>
      </div>
      <div flex one relative class="profile-skills">
        <p class="skill-header">Main Skills:</p>
        <div horizontal layout >
          <div flex>
            <ul class="skill-list">
              <template repeat="{{ skill in userSelection.selectedPerson.knows }}">
                <li >{{skill.name}}</li>
              </template>
            </ul>
          </div>
        </div>
      </div>
      <div class="allocate-hours" layout horizontal>
        <paper-input-decorator flex label="Allocation hours" floatinglabel="" error="Input a positive number!" autovalidate="" layout="" vertical="" class="invalid">
          <input is="core-input" id="allocatedHours" required="" type="number" min="0" placeholder="required" aria-label="required">
        </paper-input-decorator>
        </div>
      <div flex one relative class="profile-add">
          <div horizontal layout center center-justified fit>
            <paper-button title="Add selected employee to {{userSelection.phase.title phase}}" raised on-click="{{addEmployee}}">
              <core-icon icon="add"></core-icon>
                Add
            </paper-button>
          </div>
        </div>
    </div>
    <paper-toast id="error" text=""></paper-toast>
    <!-- <core-localstorage name="project-backup" value="{{project}}"></core-localstorage>
    <core-localstorage name="userSelectionBackup" value="{{userSelection}}"></core-localstorage> -->
  </template>
  <script>
    (function () {
      Polymer({
        created: function() {
          //
        },
        ready: function() {
          //
        },
        addEmployee: function() {
          var ajax, hours;
          hours = this.$.allocatedHours.value;
          ajax = this.$.addEmployeeAjax;
          console.log(this.userSelection.selectedSkill);
          if (hours >= 0) {
              ajax.body = JSON.stringify(
              {
                "user": this.userSelection.selectedPerson.id,
                "phase": this.userSelection.phase.id,
                "skill": this.userSelection.selectedSkill.rs.id,
                "hours": hours
              }
            );
            this.userSelection.selectedSkill.as.hours += parseInt(hours);
            ajax.go();
          }
          else {
            this.$.error.text = "Please select skill to add";
            this.$.error.show();
          }
        },
        handleResponse: function(event, res) {
          console.log(res);
          //
          //TODO
        },
        handleError: function(event, res) {
          this.fire('load-project', {msg: 'Load-project event fired'});
        }
      });
    })();
  </script>
</polymer-element>
