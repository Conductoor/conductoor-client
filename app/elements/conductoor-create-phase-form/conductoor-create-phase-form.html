<link rel="import" href="../../bower_components/polymer/polymer.html">


<polymer-element name="conductoor-create-phase-form" attributes="editMode phases currentPhase">
  <template>
    <link rel="stylesheet" href="conductoor-create-phase-form.css">
    <core-ajax
      id = "getSkillList"
      auto
      url="https://conductoor-api.herokuapp.com:443/skills/"
      params=''
      handleAs="json"
      on-core-response="{{handleResponseGetSkillList}}"
      core-error="{{handleErrorGetSkillList}}">
    </core-ajax>
    <core-ajax
      id ="postPhase"
      url="https://conductoor-api.herokuapp.com:443/phases/"
      handleAs="json"
      method="POST"
      contentType="application/json"
      on-core-response="{{handleResponsePostPhase}}"
      core-error="{{handleErrorPostPhase}}">
    </core-ajax>
    <core-ajax
      id ="putPhase"
      url="https://conductoor-api.herokuapp.com:443/phases/1/"
      handleAs="json"
      method="PUT"
      contentType="application/json"
      on-core-response="{{handleResponsePutPhase}}"
      core-error="{{handleErrorPutPhase}}">
    </core-ajax>

      <template if="{{!editPhase}}"><h2>New phase: {{phaseName}}</h2></template>
      <template if="{{editPhase}}"><h2>Editing: {{phaseName}}</h2></template>


      <form id="createProjectForm" on-submit="{{validateForm}}">
        <div layout horizontal>
          <div flex class="card">
            <paper-input-decorator floatingLabel label="Phase name" id="phaseNameDecorator">
              <input is="core-input" required maxlength="30" on-input="{{validateInput}}" error="This field is required" type="text" value="{{phaseName}}">
            </paper-input-decorator>
            <br>
            <div layout horizontal>
              <paper-input-decorator flex label="Start" style="margin-right:10px;">
                <label>Start date:</label><input is="core-input" type="date" required on-input="{{validateInput}}" value="{{phaseStart}}"></input>
              </paper-input-decorator>
              <paper-input-decorator flex label="End">
                <label>End date:</label><input is="core-input" type="date" required on-input="{{validateInput}}" value="{{phaseEnd}}"></input>
              </paper-input-decorator>
            </div>
            <br>
            <paper-input-decorator label="Desription" floatingLabel>
              <paper-autogrow-textarea>
                <textarea value="{{phaseDescription}}"></textarea>
              <paper-autogrow-textarea>
            </paper-input-decorator>
          </div>
          <div flex class="card">
            <h3>Select skills for phase:</h3>
            <core-selector id="selectSkills" selected="{{selectedSkills}}" multi valueattr="skill">
              <template repeat="{{skill in skills}}">
                  <div class="skill" skill="{{skill.name}}" on-click="{{updateFormValidity}}">{{skill.name}}</div>
                  <div class="skill-hours">
                    <core-field>
                      <core-icon icon="alarm"></core-icon>
                      <paper-input-decorator label="hours">
                        <input type="number" class="hours" skillName="{{skill.name}}" on-input="{{mapHoursToSkill}}">
                      </paper-input-decorator>
                    </core-field>
                  </div>
              </template>
            </core-selector>
          </div>
        </div>
        <br>
        <!-- paper-buttonilla submit ei toimi... -->
        <template if="{{!editPhase}}">
          <button id="submit" visible?="{{formInvalid || editPhase}}" type="submit" style="background:transparent;border:none;">
            <paper-button disabled?="{{formInvalid}}" raised>Add phase to project</paper-button>
          </button>
        </template>
        <template if="{{editPhase}}">
          <button id="submit" visible?="{{formInvalid || !editPhase}}" type="submit" style="background:transparent;border:none;">
            <paper-button disabled?="{{formInvalid}}" raised>Save</paper-button>
          </button>
         <paper-button raised on-click="{{clearForm}}">Reset</paper-button>
        </template>
      </form>
      <paper-toast id="addSuccess" text="Phase added"></paper-toast>
      <paper-toast id="addError" text="Could not add phase. Check your inputs!"></paper-toast>

  </template>


  <script>
    (function () {
      Polymer({
        created: function(){
          // missä muodossa skillit tulee?
          // TODO fetch skills
          this.skills = [];
          this.selectedSkills = [];   // Tyyppiä? [{"name":"skill1", "hours":"40"}, {"name":"skill2", "hours":"40"}];
          this.hours = [];            // Tyyppiä [{"skill":"skill1", "hours": "40"}]
          this.phaseName;
          this.phaseStart;
          this.phaseEnd;
          this.phaseDescription;
          this.phaseColor = "#000";
          this.formInvalid = true;
          //this.phaseBackup;
          this.editPhase = false;
        },
        handleResponseGetSkillList: function(event, response) {
          console.log(response.response);
          this.skills = response.response;
        },
        handleErrorGetSkillList: function(event, response) {
          console.log("Error");
          console.log(response);
        },
        handleResponsePostPhase: function(event, response) {
          console.log(response.response);
          this.skills = response.response;
        },
        handleErrorPostPhase: function(event, response) {
          console.log("Error");
          console.log(response);
        },
        handleResponsePutPhase: function(event, response) {
          console.log(response.response);
          this.skills = response.response;
        },
        handleErrorPutPhase: function(event, response) {
          console.log("Error");
          console.log(response);
        },
        addPhaseApiCall: function(phase) {
          var ajax = this.$.postPhase;
          ajax.body = JSON.stringify(
            {
              "user": "",
              "phase": "",
              "skill": "",
              "hours": ""
            }
          );
          ajax.go();
        },
        updatePhaseApiCall: function(phase) {
          var ajax = this.$.putPhase;
          ajax.body = JSON.stringify(
            {
              "user": "",
              "phase": "",
              "skill": "",
              "hours": ""
            }
          );
          ajax.go();
        },
        selectedSkillsChanged: function(){
          this.updateFormValidity();
        },
        currentPhaseChanged: function(attrName, oldVal, newVal){
          if(this.currentPhase){
            var phase = newVal[0][1];
            this.phaseName = phase.name;
            this.phaseStart = phase.start;
            this.phaseEnd = phase.end;
            this.phaseDescription = phase.description;
            this.phaseColor = phase.color;
            // select skills
            //var all_hours = this.shadowRoot.querySelectorAll(".hours");
            var hour_input;
            for (var i =0 ; i <= phase.skills.length - 1; i++) {
              hour_input = this.shadowRoot.querySelector(".hours[skillName='"+phase.skills[i].name+"']");
              hour_input.value = phase.skills[i].hours;
              this.selectedSkills.push(phase.skills[i].name);
            }
            this.formInvalid = false;
            this.editPhase = true;
          }
        },

        mapHoursToSkill: function(event, detail, sender){
          var hours = sender.value;
          var skill = sender.getAttribute("skillName");
          if(this.isNumeric(hours) && _.contains(this.selectedSkills, skill)){
            // check if hours has changed
            if( _.findWhere(this.hours, {skill:skill}) ){
              var idx = _.indexOf(_.pluck(this.hours, 'skill'), skill);
              this.hours[idx].hours = hours;
            }
            else
              this.hours.push({"skill":skill, "hours":hours});
          }
        },
        isNumeric: function(n) {
          return !isNaN(parseFloat(n)) && isFinite(n);
        },
        createPhase: function(){
          // generate random color --> works as ID?
          this.phaseColor = this.editPhase ? this.phaseColor : this.getRandomColor();
          // create skill objects
          var skills = [];
          for (var i = this.selectedSkills.length - 1; i >= 0; i--) {
            var hours = _.findWhere(this.hours, {skill:this.selectedSkills[i]});
            // add to skills only when skill has hours set!
            if(hours){
              skills.push({"name":this.selectedSkills[i], "hours":hours.hours});
            }
          }
          var phase = {"name":this.phaseName, "start":this.phaseStart, "end":this.phaseEnd, "description": this.phaseDescription, "color":this.phaseColor, "skills":skills};
          return phase;
        },
        addPhase: function(){
          var exists = 0;
          var current = this.phaseName;
          // can't have two phases with same name
          for (var i = this.phases.length - 1; i >= 0; i--) {
            if (this.phases[i].name === current && !this.editPhase) {
              alert("Already phase with that name!");   // REDO alert...
              exists = 1;
            }
          }
          var phase = this.createPhase();
          // Add new phase
          if (!exists && !this.editPhase) {
            this.addPhaseApiCall(phase);
            this.phases.push(phase);
            this.$.addSuccess.show();
          }
          // Update existing phase
          else if(!exists && this.editPhase){
            //console.log( _.indexOf(_.pluck(this.phases, 'color'), phase.color) );
            this.updatePhaseApiCall(phase);
            var idx = _.indexOf(_.pluck(this.phases, 'color'), phase.color);
            this.phases[idx] = phase;
          }
          this.clearForm();
        },

        getRandomColor: function() {
          var letters = '0123456789ABCDEF'.split('');
          var color = ''; //#
          for (var i = 0; i < 6; i++ ) {
              color += letters[Math.floor(Math.random() * 16)];
          }
          return this.changeLuminance(color, -0.4);
        },

        changeLuminance: function(hex, lum) {
          // validate hex string
          hex = String(hex).replace(/[^0-9a-f]/gi, '');
          if (hex.length < 6) {
            hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
          }
          lum = lum || 0;
          // convert to decimal and change luminosity
          var rgb = "", c, i; //#
          for (i = 0; i < 3; i++) {
            c = parseInt(hex.substr(i*2,2), 16);
            c = Math.round(Math.min(Math.max(0, c + (c * lum)), 255)).toString(16);
            rgb += ("00"+c).substr(c.length);
          }
          // check that color is unique
          if (this.validateColor(rgb)){
            getRandomColor();
          }
          else{
            return rgb;
          }
        },
        validateColor: function(color){
          // color is considered as the id of a phase --> unique!
          var colors = _.map(this.phases, "color");
          console.log("color alreay exists: "+_.contains(colors, color));
          return _.contains(colors, color);
        },

        validateInput: function(e){
          var d = e.target.parentNode;
          d.isInvalid = !e.target.validity.valid;
          this.updateFormValidity();
        },

        updateFormValidity: function(){
          var myform = this.$.createProjectForm;
          var invalid = false;
          // check validity of form fields
          Array.prototype.forEach.call(myform, function(child) {
            if (child.validity.valid === false) {
              invalid = true;
            }
          });
          if(!this.selectedSkills.length){invalid = true};
          this.formInvalid = invalid;
        },

        validateForm: function(e) {
          e.preventDefault();
          // validate data
          var valid = true;
          if(this.phaseName.length > 30 || this.phaseName.length === 0){
            valid = false;
          }
          // strip tags
          this.phaseName = this.phaseName.replace(/(<([^>]+)>)/ig,"");
          // check date format
          var re = /^(\d{4})-(\d{1,2})-(\d{1,2})$/;
          // console.log(this.phaseStart);
          if(this.phaseStart.length === 0 || this.phaseEnd.length === 0 || !this.phaseStart.match(re) || !this.phaseEnd.match(re) ){
            valid = false;
          }
          // at least one skill required
          if(this.selectedSkills.length === 0){
            valid = false;
          }
          // if data valid --> add phase
          valid === true ? this.addPhase() : this.$.addError.show();
        },

        clearForm: function(){
          this.$.createProjectForm.reset();
          // reset variables
          this.selectedSkills = [];
          // pelkkä reset ei riitä --> phase edit ei toimi normisti
          this.phaseName = "";
          this.phaseStart = "";
          this.phaseEnd = "";
          this.phaseDescription = "";
          this.phaseColor = "#000";
          this.formInvalid = true;
          this.editPhase = false;
          this.currentPhase = null;
        }
      });
    })();
  </script>
</polymer-element>
